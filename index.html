<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Absensi PAI - Modern & Music Persistent</title>
    <style>
        :root {
            /* Palette Warna Modern */
            --primary: #10b981; /* Emerald Green */
            --primary-dark: #047857;
            --secondary: #6366f1; /* Indigo */
            --secondary-dark: #4338ca;
            --quiz-color: #db2777; /* Pink */
            --quiz-dark: #be185d;
            --music-color: #8b5cf6; /* Violet */
            --music-dark: #7c3aed;
            --home-color: #0ea5e9; /* Sky Blue */
            --bg-body: #f3f4f6; /* Light Gray Background */
            --bg-card: #ffffff;
            --text-main: #1f2937;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --shadow-soft: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            --shadow-active: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            
            /* Warna Status Absensi */
            --col-h: #dcfce7; --txt-h: #166534;
            --col-i: #fef9c3; --txt-i: #854d0e;
            --col-s: #dbeafe; --txt-s: #1e40af;
            --col-a: #fee2e2; --txt-a: #991b1b;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', 'Segoe UI', Roboto, Helvetica, sans-serif; }

        body { background-color: var(--bg-body); color: var(--text-main); display: flex; height: 100vh; overflow: hidden; }

        /* SIDEBAR */
        aside { 
            width: 280px; background: #ffffff; border-right: 1px solid var(--border); 
            display: flex; flex-direction: column; padding: 2rem; z-index: 20; box-shadow: var(--shadow-soft);
            transition: transform 0.3s ease;
        }
        
        .school-profile { text-align: center; margin-bottom: 2.5rem; padding-bottom: 2rem; border-bottom: 2px dashed var(--border); }
        .logo-container { width: 110px; height: 110px; margin: 0 auto 20px; background: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 20px rgba(0,0,0,0.08); border: 4px solid #e2e8f0; overflow: hidden; }
        .school-logo { width: 100%; height: 100%; object-fit: contain; }
        
        .school-name { font-size: 1.3rem; font-weight: 900; color: var(--primary); margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px; line-height: 1.2; }
        .mapel-badge { display: inline-block; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 6px 16px; border-radius: 25px; font-size: 0.9rem; font-weight: 700; margin-top: 12px; box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2); }
        .teacher-info { font-size: 0.95rem; color: var(--text-muted); margin-top: 5px; font-weight: 600; background: #f1f5f9; padding: 4px 10px; border-radius: 6px; display: inline-block; }

        .menu-label { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 1rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1.2px; }
        .class-list { list-style: none; display: flex; flex-direction: column; gap: 8px; overflow-y: auto; flex: 1; padding-right: 5px; }
        .class-btn { width: 100%; padding: 1rem; text-align: left; border: 2px solid transparent; border-radius: 10px; background: #f8fafc; cursor: pointer; font-weight: 600; color: var(--text-main); transition: all 0.2s; font-size: 1rem; display: flex; align-items: center; justify-content: space-between; }
        .class-btn:hover { background: #f1f5f9; border-color: #cbd5e1; }
        .class-btn.active { background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); color: var(--primary); border: none; font-weight: 800; box-shadow: var(--shadow-active); }

        /* MAIN CONTENT */
        main { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; background: #fafafa; }
        
        header { background: #ffffff; padding: 1rem 2rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.04); }
        .header-title h2 { font-size: 1.4rem; font-weight: 800; color: var(--text-main); letter-spacing: -0.5px; }
        .header-actions { display: flex; gap: 12px; }
        
        .btn-action { border: none; padding: 0.7rem 1.2rem; border-radius: 10px; font-size: 0.9rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s; width: 100%; justify-content: center; font-family: inherit; }
        
        .btn-music { background: linear-gradient(135deg, var(--music-color), var(--music-dark)); color: white; border: 1px solid rgba(255,255,255,0.2); }
        .btn-music.music-active-playing { box-shadow: 0 0 15px rgba(139, 92, 246, 0.4); animation: pulse-glow 2s infinite; }
        .btn-music:hover { filter: brightness(1.1); transform: translateY(-2px); }
        
        .btn-lock { background: var(--secondary); color: white; border: 1px solid rgba(255,255,255,0.1); }
        .btn-lock:hover { background: var(--secondary-dark); transform: translateY(-2px); }
        .btn-lock.locked { background: #ef4444; }
        
        .btn-print { background: var(--home-color); color: white; }
        .btn-print:hover { background: #0284c7; transform: translateY(-2px); }
        
        .btn-download { background: var(--primary); color: white; }
        .btn-download:hover { background: var(--primary-dark); transform: translateY(-2px); }
        
        /* TOMBOL FOOTER SIDEBAR */
        .sidebar-footer { margin-top: auto; display: flex; flex-direction: column; gap: 12px; padding-top: 20px; border-top: 1px solid #f1f5f9; }
        .btn-home { background: white; color: var(--home-color); border: 2px solid var(--home-color); padding: 1rem; border-radius: 10px; font-weight: 700; font-size: 0.95rem; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; }
        .btn-home:hover { background: #f0f9ff; }
        .btn-reset { background: white; color: #ef4444; border: 2px solid #ef4444; padding: 1rem; border-radius: 10px; font-weight: 700; font-size: 0.95rem; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; }
        .btn-reset:hover { background: #fef2f2; }

        /* Animasi Musik */
        @keyframes pulse-glow {
            0% { box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.6); }
            50% { box-shadow: 0 0 20px rgba(139, 92, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(139, 92, 246, 0); }
        }

        .content-scroll { padding: 2.5rem; overflow-y: auto; flex: 1; }
        
        /* Navigasi Tab */
        .nav-tabs { display: flex; gap: 10px; margin-bottom: 2rem; background: white; padding: 10px; border-radius: 16px; border: 1px solid var(--border); box-shadow: var(--shadow-soft); overflow-x: auto; }
        .nav-btn { padding: 0.8rem 1.2rem; border-radius: 10px; background: transparent; cursor: pointer; font-weight: 600; color: var(--text-muted); flex: 1; text-align: center; transition: all 0.2s; font-size: 0.95rem; display: flex; align-items: center; justify-content: center; gap: 8px; white-space: nowrap; border: 1px solid transparent; }
        .nav-btn:hover { background: #f8fafc; color: var(--text-main); }
        .nav-btn.active-absen { background: var(--primary); color: white; box-shadow: var(--shadow-active); }
        .nav-btn.active-nilai { background: var(--secondary); color: white; box-shadow: var(--shadow-active); }
        .nav-btn.active-kuis { background: var(--quiz-color); color: white; box-shadow: var(--shadow-active); }
        .nav-btn.active-hasil { background: #f59e0b; color: white; box-shadow: var(--shadow-active); }

        /* GAME AREA */
        .game-container {
            background: white; padding: 2.5rem; border-radius: 20px;
            box-shadow: 0 20px 40px rgba(219, 39, 119, 0.2);
            border: 1px solid #fbcfe8; margin-bottom: 2rem;
            text-align: center;
            max-width: 850px; margin-left: auto; margin-right: auto;
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes slideUp { from {opacity: 0; transform: translateY(20px);} to {opacity: 1; transform: translateY(0);} }
        
        .game-title { font-size: 2rem; font-weight: 900; color: var(--quiz-color); margin-bottom: 1.5rem; letter-spacing: 0.5px; }
        .game-desc { color: var(--text-muted); margin-bottom: 2rem; font-size: 1.1rem; line-height: 1.5; }

        .form-group-game { margin-bottom: 2rem; text-align: left; }
        .form-label-game { font-weight: 700; display: block; margin-bottom: 0.8rem; color: var(--text-main); font-size: 1rem; }
        .game-input { width: 100%; padding: 14px; border: 2px solid var(--border); border-radius: 10px; font-size: 1.1rem; outline: none; background: #f8fafc; transition: 0.2s; }
        .game-input:focus { border-color: var(--quiz-color); box-shadow: 0 0 0 3px rgba(219, 39, 119, 0.15); background: white; }

        .btn-start-game { background: linear-gradient(135deg, var(--quiz-color), var(--quiz-dark)); color: white; width: 100%; padding: 16px; font-size: 1.2rem; font-weight: 800; border: none; border-radius: 12px; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 10px rgba(219, 39, 119, 0.3); letter-spacing: 0.5px; }
        .btn-start-game:hover { transform: translateY(-3px); filter: brightness(1.05); }

        .question-card { margin-bottom: 2rem; text-align: left; padding: 2rem; background: #fdf2f8; border-radius: 15px; border: 1px solid #fbcfe8; }
        .q-text { font-size: 1.3rem; font-weight: 800; margin-bottom: 1.2rem; color: #831843; line-height: 1.4; }
        .q-options { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .q-option { padding: 15px; background: white; border: 2px solid #fbcfe8; border-radius: 10px; cursor: pointer; transition: 0.2s; font-weight: 600; display: flex; align-items: center; gap: 12px; font-size: 1rem; }
        .q-option:hover { background: #fce7f3; border-color: var(--quiz-color); transform: translateY(-2px); }
        .q-option input:checked + span { color: var(--quiz-color); font-weight: 800; }
        
        .result-box { background: linear-gradient(135deg, #dcfce7, #bbf7d0); color: #166534; padding: 2.5rem; border-radius: 20px; border: 2px solid #86efac; margin-bottom: 2rem; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .result-score { font-size: 4.5rem; font-weight: 900; display: block; margin: 10px 0; text-shadow: 2px 2px 5px rgba(0,0,0,0.1); }
        
        .hidden { display: none; }

        /* Input Area Siswa Biasa */
        .add-box { display: flex; gap: 12px; margin-bottom: 2rem; background: white; padding: 20px; border-radius: 15px; border: 1px solid var(--border); box-shadow: var(--shadow-soft); }
        .add-input { flex: 1; padding: 14px; border: 2px solid var(--border); border-radius: 10px; font-size: 1.1rem; outline: none; background: #f8fafc; transition: 0.2s; }
        .add-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.15); background: white; }
        .add-btn { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; border: none; padding: 0 2rem; border-radius: 10px; cursor: pointer; font-weight: 700; font-size: 1.1rem; box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3); letter-spacing: 0.5px; transition: 0.2s; }
        .add-btn:hover { transform: translateY(-2px); filter: brightness(1.05); }

        /* Table Style (Modern Excel Look) */
        .grid-container { background: var(--bg-card); border-radius: 20px; border: 1px solid var(--border); overflow: auto; position: relative; box-shadow: var(--shadow-soft); margin-top: 1rem; }
        table { border-collapse: collapse; min-width: 100%; width: 100%; table-layout: fixed; } 
        
        th { background: #f8fafc; padding: 14px 8px; font-size: 0.9rem; text-align: center; border: 1px solid var(--border); position: sticky; top: 0; z-index: 5; font-weight: 700; color: var(--text-muted); border-bottom: 2px solid #e2e8f0; letter-spacing: 0.5px; }
        td { padding: 0; border: 1px solid var(--border); text-align: center; font-size: 0.95rem; height: 55px; background: white; transition: 0.1s; }
        tbody tr:hover { background-color: #fdf4ff; }

        /* Sticky Columns (No & Nama) */
        th.sticky-col, td.sticky-col {
            position: sticky; left: 0; background: var(--bg-card); z-index: 10; min-width: 60px; text-align: center; border-right: 2px solid #94a3b8; display: flex; align-items: center; justify-content: center; box-shadow: 2px 0 5px rgba(0,0,0,0.03); }
        th.sticky-col, td.sticky-col { font-weight: 800; color: var(--text-main); }
        
        th.sticky-col-second, td.sticky-col-second {
            position: sticky; left: 60px; background: var(--bg-card); z-index: 10; min-width: 220px; text-align: left; padding: 0 20px; border-right: 2px solid #94a3b8; display: flex; align-items: center; justify-content: space-between;
        }
        th.sticky-col-second { z-index: 15; background: #f8fafc; font-weight: 800; color: var(--primary); border-right: 2px solid #94a3b8; }
        
        /* Excel-like Clickable Cell */
        .day-cell { 
            cursor: pointer; font-weight: 700; transition: all 0.1s; user-select: none; font-size: 1.3rem; 
            width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;
            border-radius: 8px; /* Lebih bulat agar modern */
        }
        .day-cell:hover { transform: scale(1.1); filter: brightness(0.95); }
        
        /* Urutan Warna Baru */
        .status-H { background-color: var(--col-h); color: var(--txt-h); box-shadow: 0 1px 3px rgba(22, 163, 74, 0.1); }
        .status-I { background-color: var(--col-i); color: var(--txt-i); box-shadow: 0 1px 3px rgba(245, 158, 11, 0.1); }
        .status-S { background-color: var(--col-s); color: var(--txt-s); box-shadow: 0 1px 3px rgba(59, 130, 246, 0.1); }
        .status-A { background-color: var(--col-a); color: var(--txt-a); box-shadow: 0 1px 3px rgba(153, 27, 27, 0.1); }
        .status- { background-color: #f8fafc; color: #cbd5e1; }

        .grade-input { width: 100%; height: 100%; border: none; text-align: center; font-weight: 700; color: var(--text-main); background: transparent; outline: none; font-size: 1.3rem; }
        .grade-input:focus { background: #e0e7ff; }
        .grade-input:disabled { background: #f8fafc; color: #cbd5e1; cursor: not-allowed; }
        
        .quiz-avg { font-weight: 900; color: var(--quiz-color); font-size: 1.4rem; }

        .info-box { background: #fff7ed; color: #b45309; padding: 16px 20px; border-radius: 12px; font-size: 0.95rem; margin-bottom: 2rem; border: 1px solid #fcd34d; display: flex; align-items: center; gap: 12px; box-shadow: 0 1px 2px rgba(251, 191, 36, 0.1); }
        
        .btn-del { color: #cbd5e2; cursor: pointer; font-weight: 800; font-size: 1.4rem; line-height: 1; padding: 0 10px; opacity: 0.5; transition: 0.2s; }
        .btn-del:hover { color: #ef4444; transform: rotate(90deg); }

        .score-badge { display: inline-block; padding: 8px 16px; border-radius: 12px; font-weight: 800; font-size: 1.2rem; min-width: 60px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); letter-spacing: 1px; }
        .score-high { background: #dcfce7; color: #166534; border: 1px solid #86efac; box-shadow: 0 2px 5px rgba(22, 163, 74, 0.1); } 
        .score-med { background: #fef9c3; color: #854d0e; border: 1px solid #fde047; } 
        .score-low { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; box-shadow: 0 2px 5px rgba(153, 27, 27, 0.1); }

        /* Mobile */
        .menu-toggle { display: none; background: none; border: none; font-size: 1.8rem; cursor: pointer; color: var(--text-main); }
        @media (max-width: 768px) {
            aside { position: absolute; height: 100%; transform: translateX(-100%); transition: transform 0.3s ease; width: 280px; }
            aside.open { transform: translateX(0); }
            .menu-toggle { display: block; }
            .nav-tabs { overflow-x: auto; padding: 10px; }
            .nav-btn { flex: 0 0 auto; min-width: 140px; padding: 0.6rem 1rem; }
            .header-actions span { display: none; }
            th.sticky-col-second, td.sticky-col-second { min-width: 180px; }
            .q-options { grid-template-columns: 1fr; }
        }

        /* PRINT STYLES */
        @media print {
            aside, .add-box, .nav-tabs, .info-box, .header-actions, .menu-toggle, .game-container, .sidebar-footer { display: none !important; }
            main, .content-scroll, body { height: auto !important; overflow: visible !important; display: block !important; background: white !important; padding: 0 !important; margin: 0 !important; }
            .print-header { display: block !important; text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #000; }
            .grid-container { box-shadow: none; border: 2px solid #000; margin-top: 20px; }
            table { font-size: 10pt; width: 100%; }
            th, td { border: 1px solid #000 !important; color: #000 !important; padding: 8px; }
            .school-profile { border: none; margin-bottom: 10px; }
            th.sticky-col, td.sticky-col { border-right: 2px solid #000; }
            th.sticky-col-second, td.sticky-col-second { border-right: 2px solid #000; }
            .status-H { background: none !important; color: #000 !important; }
            .status-I { background: none !important; color: #000 !important; }
            .status-S { background: none !important; color: #000 !important; }
            .status-A { background: none !important; color: #000 !important; }
            .day-cell { height: 30px; font-size: 12pt; }
            .score-badge { border: 1px solid #000; background: none; color: #000; }
        }
        .print-header { display: none; }
    </style>
</head>
<body>

    <!-- AUDIO (Mode Tetap) -->
    <audio id="bgMusic" loop>
        <source src="djtormonitor.mp3" type="audio/mpeg">
    </audio>

    <!-- Header Print -->
    <div class="print-header">
        <div style="display:flex; justify-content:center; margin-bottom:20px;">
            <img src="./logo-sdn-banjarwangi.png" alt="Logo" style="width:100px; height:100px; object-fit:contain;">
        </div>
        <h1 style="font-size:28px; text-transform:uppercase; margin:0; color:#000; letter-spacing: 2px;">SDN BANJARWANGI</h1>
        <h3 style="margin:5px 0; color:#000; font-size: 18px;">Pendidikan Agama Islam</h3>
        <p style="margin:5px 0 30px 0; font-weight:bold; color:#000;">Laporan Hasil Belajar Siswa</p>
        <div style="border-top: 3px double #000; margin: 30px 0;"></div>
    </div>

    <!-- SIDEBAR -->
    <aside id="sidebar">
        <div class="school-profile">
            <div class="logo-container">
                <img src="./logo-sdn-banjarwangi.png" onerror="this.src='https://via.placeholder.com/110?text=LOGO';" class="school-logo">
            </div>
            <h2 class="school-name">SDN Banjarwangi</h2>
            <div class="mapel-badge">Pendidikan Agama Islam</div>
            <div class="teacher-info">Guru: <span id="lblTeacher">SHABUDIN</span></div>
        </div>

        <div class="menu-label">Pilih Kelas</div>
        <ul class="class-list" id="classList"></ul>
        
        <div class="sidebar-footer">
            <button class="btn-home" onclick="goToHome()">
                üè† Menu Utama
            </button>
            <button class="btn-reset" onclick="resetAll()">
                üóëÔ∏è Reset Data
            </button>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main>
        <header>
            <div class="header-title">
                <div style="display:flex; align-items:center; gap:15px;">
                    <button class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
                    <h2 id="pageTitle">Sistem Absensi</h2>
                </div>
            </div>
            
            <div class="header-actions">
                <button class="btn-action btn-music" id="btnMusic" onclick="toggleMusic()" title="Putar Musik">
                    üéµ <span id="musicLabel">Musik</span>
                </button>
                <button class="btn-action btn-lock" id="btnLock" onclick="toggleLock()" title="Kunci Edit">
                    üîì <span>Kunci</span>
                </button>
                <button class="btn-action btn-print" onclick="window.print()" title="Cetak Laporan">
                    üñ®Ô∏è <span>Cetak</span>
                </button>
                <button class="btn-action btn-download" onclick="downloadCSV()" title="Unduh Excel">
                    üì• <span>Excel</span>
                </button>
            </div>
        </header>

        <div class="content-scroll">
            
            <!-- 6 MENU UTAMA -->
            <div class="nav-tabs">
                <button class="nav-btn" id="btnAbsen" onclick="switchView('absen')">üìÖ Absensi</button>
                <button class="nav-btn" id="btnNilai" onclick="switchView('nilai')">üíØ Nilai Harian</button>
                <button class="nav-btn" id="btnQuiz" onclick="switchView('quiz')">üß† Mode Kuis & Game</button>
                <button class="nav-btn" id="btnRecapAbsen" onclick="switchView('recap_absen')">üìä Rekap Absen</button>
                <button class="nav-btn" id="btnRecapNilai" onclick="switchView('recap_nilai')">üìà Rekap Nilai</button>
                <button class="nav-btn" id="btnHasil" onclick="switchView('hasil')">üöÄ Hasil Akhir</button>
            </div>

            <!-- INFO LOGIKA (Hanya di Hasil) -->
            <div id="logicInfo" class="info-box" style="display:none;">
                <span>üßÆ Logika Perhitungan:</span> 
                (Rata-rata Nilai Harian + Rata-rata Kuis) dibagi 2. 
            </div>

            <!-- GAME KUIS -->
            <div id="gameArea" class="hidden">
                <div id="gameIntro" class="game-container">
                    <h2 class="game-title">üéÆ Kuis Pendidikan Agama Islam</h2>
                    <p class="game-desc">Masukkan data diri untuk memulai kuis interaktif.</p>
                    
                    <div class="form-group-game">
                        <label class="form-label-game">Pilih Kelas:</label>
                        <select id="gameClassSelect" class="game-input"></select>
                    </div>

                    <div class="form-group-game">
                        <label class="form-label-game">Nama Siswa (Sesuai Daftar Kelas):</label>
                        <input type="text" id="gameNameInput" class="game-input" placeholder="Ketik nama lengkap..." list="studentDatalist">
                        <datalist id="studentDatalist"></datalist>
                    </div>

                    <div class="form-group-game">
                        <label class="form-label-game">Nomor Kuis:</label>
                        <select id="gameQuizNum" class="game-input">
                            <option value="1">Kuis 1</option>
                            <option value="2">Kuis 2</option>
                            <option value="3">Kuis 3</option>
                            <option value="4">Kuis 4</option>
                            <option value="5">Kuis 5</option>
                            <option value="6">Kuis 6</option>
                            <option value="7">Kuis 7</option>
                            <option value="8">Kuis 8</option>
                            <option value="9">Kuis 9</option>
                            <option value="10">Kuis 10</option>
                        </select>
                    </div>

                    <button class="btn-start-game" onclick="startGame()">MULAI KUIS üöÄ</button>
                </div>

                <div id="gameQuestions" class="game-container hidden">
                    <h2 class="game-title" style="font-size:1.6rem;">Jawab Pertanyaan Berikut:</h2>
                    <div id="questionsRender"></div>
                    <button class="btn-start-game" onclick="submitGame()" style="background:var(--primary); margin-top:20px; border-radius: 12px;">SELESAI & SIMPAN NILAI üíæ</button>
                </div>

                <div id="gameResult" class="game-container hidden">
                    <div class="result-box">
                        <h3>Nilai Kamu:</h3>
                        <span id="finalScoreDisplay" class="result-score">0</span>
                        <p id="resultMessage" style="font-size: 1.1rem; font-weight: 600;">Nilai telah tersimpan otomatis ke rekap!</p>
                    </div>
                    <button class="btn-start-game" onclick="resetGame()" style="background: white; color: var(--text-main); border: 2px solid var(--border);">MAIN UNTUK SISWA LAIN ‚Ü∫</button>
                </div>
            </div>

            <!-- TAMBAH SISWA -->
            <div class="add-box">
                <input type="text" id="inpName" class="add-input" placeholder="Ketik nama siswa baru..." onkeypress="handleEnter(event)">
                <button class="add-btn" onclick="addStudent()">+ Tambah</button>
            </div>

            <!-- TABEL DATA -->
            <div class="grid-container">
                <table id="mainTable">
                    <thead>
                        <tr id="tableHeader">
                            <!-- Header akan diisi oleh JS -->
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        // --- KONFIGURASI UTAMA ---
        const TEACHER_NAME = "SHABUDIN";
        const classes = ["Kelas 4A", "Kelas 4B", "Kelas 4C", "Kelas 3A", "Kelas 3B", "Kelas 3C"];
        const months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
        const totalDays = 16; // 16 PERTEMUAN
        const totalQuizzes = 10; 

        const PENALTI_ALPHA = 5;
        const PENALTI_SAKIT = 2;
        const PENALTI_IZIN = 2;

        // SOAL PAI
        const quizQuestions = [
            { q: "Berapa jumlah Rukun Islam?", options: ["5 Rukun", "4 Rukun", "6 Rukun", "3 Rukun"], ans: 0 },
            { q: "Rukun Islam yang pertama adalah?", options: ["Sholat", "Zakat", "Puasa", "Syahadat"], ans: 3 },
            { q: "Sholat wajib sehari semalam berjumlah?", options: ["5 Waktu", "4 Waktu", "3 Waktu", "6 Waktu"], ans: 0 },
            { q: "Puasa wajib dilaksanakan di bulan?", options: ["Ramadhan", "Syawal", "Muharram", "Dzulhijjah"], ans: 0 },
            { q: "Zakat Fitrah wajib dikeluarkan pada bulan?", options: ["Ramadhan", "Syawal", "Muharram", "Rajab"], ans: 0 },
            { q: "Rukun Iman yang pertama adalah percaya kepada?", options: ["Malaikat", "Kitab", "Allah", "Rasul"], ans: 2 },
            { q: "Nabi Muhammad SAW diutus di kota?", options: ["Madinah", "Mekkah", "Yerusalem", "Kairo"], ans: 1 },
            { q: "Kitab suci umat Islam adalah?", options: ["Zabur", "Taurat", "Injil", "Al-Quran"], ans: 3 },
            { q: "Malaikat yang bertugas mencatat amal baik adalah?", options: ["Jibril", "Mikail", "Raqib", "Atid"], ans: 2 },
            { q: "Ibadah haji dilaksanakan di kota?", options: ["Mekkah", "Madinah", "Jeddah", "Taif"], ans: 0 }
        ];

        let isLocked = false; 
        let isPlaying = false;
        
        let appData = { 
            currentClassIdx: 0, 
            currentMonthIdx: new Date().getMonth(), // Auto Load Current Month
            currentYear: new Date().getFullYear(), // Simpan Tahun Juga
            viewMode: 'absen', 
            students: {}, 
            attendance: {},
            grades: {},
            quizzes: {} 
        };

        // Kunci untuk menyimpan state musik secara terpisah
        const MUSIC_KEY = 'app_sekolah_music_state_v2';

        window.onload = function() {
            const saved = localStorage.getItem('app_sekolah_vfinal_modern_persistent');
            if (saved) { 
                appData = JSON.parse(saved);
                classes.forEach(c => {
                    if(!appData.students[c]) appData.students[c] = [];
                    if(!appData.attendance[c]) appData.attendance[c] = {};
                    if(!appData.grades[c]) appData.grades[c] = {};
                    if(!appData.quizzes[c]) appData.quizzes[c] = {};
                });
                saveData();
            } else { 
                initEmptyData(); 
            }
            
            document.getElementById('lblTeacher').innerText = TEACHER_NAME;
            
            // --- LOGIKA MODE LAGU TETAP (PERSISTENT) ---
            const savedMusicState = localStorage.getItem(MUSIC_KEY);
            if (savedMusicState === 'true') {
                isPlaying = true;
                updateMusicButtonUI(true);
                // Coba play otomatis (browser mungkin menolak tanpa interaksi pertama)
                const audio = document.getElementById("bgMusic");
                audio.play().catch(e => console.log("Autoplay blocked:", e));
            } else {
                isPlaying = false;
                updateMusicButtonUI(false);
            }

            // Error Handler Audio
            const audio = document.getElementById("bgMusic");
            audio.onerror = function() {
                alert("PERINGATAN: File lagu 'djtormonitor.mp3' tidak ditemukan!");
                const btn = document.getElementById('btnMusic');
                btn.disabled = true;
                btn.style.opacity = "0.5";
            };
            
            renderAll();
        };

        function initEmptyData() {
            classes.forEach(c => { 
                appData.students[c] = []; 
                appData.attendance[c] = {};
                appData.grades[c] = {}; 
                appData.quizzes[c] = {}; 
            });
            saveData();
        }

        function saveData() { 
            localStorage.setItem('app_sekolah_vfinal_modern_persistent', JSON.stringify(appData));
            // Simpan state musik bersamaan
            localStorage.setItem(MUSIC_KEY, isPlaying ? 'true' : 'false');
        }

        function resetAll() {
            if(confirm("HAPUS SEMUA DATA? Data tidak bisa dikembalikan.")) { 
                localStorage.removeItem('app_sekolah_vfinal_modern_persistent'); 
                location.reload(); 
            }
        }

        function goToHome() {
            if(confirm("Kembali ke tampilan awal (Kelas 4A / Tab Absensi)?")) {
                appData.currentClassIdx = 0;
                appData.currentMonthIdx = new Date().getMonth(); // Reset ke bulan sekarang juga
                appData.currentYear = new Date().getFullYear();
                appData.viewMode = 'absen';
                saveData();
                renderAll();
                document.getElementById('sidebar').classList.remove('open');
            }
        }

        // --- LOGIKA MUSIK ---
        function toggleMusic() {
            const audio = document.getElementById("bgMusic");
            const btn = document.getElementById('btnMusic');
            const label = document.getElementById('musicLabel');
            
            if (isPlaying) {
                audio.pause();
                isPlaying = false;
                updateMusicButtonUI(false);
            } else {
                audio.play().then(() => {
                    isPlaying = true;
                    updateMusicButtonUI(true);
                }).catch(error => { console.error("Audio Play Error:", error); alert("Gagal memutar musik. Pastikan Anda mengklik halaman terlebih dahulu."); });
            }
        }

        function updateMusicButtonUI(playing) {
            const btn = document.getElementById('btnMusic');
            const label = document.getElementById('musicLabel');
            if (playing) {
                btn.classList.add('music-active-playing');
                label.innerText = "ON"; // Label lebih simpel untuk status
            } else {
                btn.classList.remove('music-active-playing');
                label.innerText = "OFF";
            }
        }

        // --- RENDER UTAMA ---
        function renderAll() {
            renderSidebar(); 
            renderTableHeader(); 
            renderTableBody(); 
            updateInfoBox();
            updateTitle();
            updateGameUI();
        }

        function renderSidebar() {
            const list = document.getElementById('classList');
            list.innerHTML = '';
            classes.forEach((c, idx) => {
                const li = document.createElement('li');
                const btn = document.createElement('button');
                btn.className = `class-btn ${idx === appData.currentClassIdx ? 'active' : ''}`;
                btn.innerText = c;
                btn.onclick = () => switchClass(idx);
                li.appendChild(btn);
                list.appendChild(li);
            });
        }

        function switchClass(idx) {
            appData.currentClassIdx = idx;
            saveData();
            renderAll();
        }

        function switchView(mode) {
            appData.viewMode = mode;
            document.querySelectorAll('.nav-btn').forEach(b => b.className = 'nav-btn');
            
            if(mode === 'absen') document.getElementById('btnAbsen').classList.add('active-absen');
            else if(mode === 'nilai') document.getElementById('btnNilai').classList.add('active-nilai');
            else if(mode === 'quiz') document.getElementById('btnQuiz').classList.add('active-kuis');
            else if(mode === 'recap_absen') document.getElementById('btnRecapAbsen').classList.add('active-absen');
            else if(mode === 'recap_nilai') document.getElementById('btnRecapNilai').classList.add('active-nilai');
            else if(mode === 'hasil') document.getElementById('btnHasil').classList.add('active-hasil');

            const gameArea = document.getElementById('gameArea');
            if(mode === 'quiz') {
                gameArea.classList.remove('hidden');
                resetGame(); 
            } else {
                gameArea.classList.add('hidden');
            }

            renderTableHeader();
            renderTableBody();
            updateInfoBox();
            updateTitle();
        }

        function updateTitle() {
            const mthName = months[appData.currentMonthIdx];
            const yearNum = appData.currentYear;
            const clsName = classes[appData.currentClassIdx];
            let titleText = "";
            
            if(appData.viewMode === 'absen') titleText = `Absensi (16 Pertemuan) - ${mthName} ${yearNum}`;
            else if(appData.viewMode === 'nilai') titleText = `Nilai Harian (16 Pertemuan) - ${mthName} ${yearNum}`;
            else if(appData.viewMode === 'quiz') titleText = "Mode Kuis & Game PAI";
            else if(appData.viewMode === 'recap_absen') titleText = "Rekap Absensi - " + mthName;
            else if(appData.viewMode === 'recap_nilai') titleText = "Rekap Nilai - " + mthName;
            else if(appData.viewMode === 'hasil') titleText = "Hasil Akhir Siswa - " + mthName;
            
            document.getElementById('pageTitle').innerText = titleText;
        }

        function updateInfoBox() {
            const info = document.getElementById('logicInfo');
            info.style.display = (appData.viewMode === 'hasil' || appData.viewMode === 'absen' || appData.viewMode === 'nilai') ? 'flex' : 'none';
        }

        // --- GAME FUNCTIONS ---
        function updateGameUI() {
            const clsSelect = document.getElementById('gameClassSelect');
            clsSelect.innerHTML = '';
            classes.forEach((c, idx) => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.innerText = c;
                if(idx === appData.currentClassIdx) opt.selected = true;
                clsSelect.appendChild(opt);
            });

            const dl = document.getElementById('studentDatalist');
            dl.innerHTML = '';
            const currentClass = classes[appData.currentClassIdx];
            if(appData.students[currentClass]) {
                appData.students[currentClass].forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.name;
                    dl.appendChild(opt);
                });
            }
        }

        function startGame() {
            const clsName = document.getElementById('gameClassSelect').value;
            const studentName = document.getElementById('gameNameInput').value.trim();
            const quizNum = document.getElementById('gameQuizNum').value;

            if(!studentName) return alert("Nama harus diisi!");
            
            const student = appData.students[clsName].find(s => s.name.toLowerCase() === studentName.toLowerCase());

            if(!student) {
                alert(`Siswa bernama "${studentName}" TIDAK DITEMUKAN di Kelas ${clsName}.\n\nHarap cek kembali nama atau tambahkan siswa di menu utama.`);
                return;
            }

            window.currentGame = {
                studentId: student.id,
                studentName: student.name,
                className: clsName,
                quizNum: quizNum
            };

            const container = document.getElementById('questionsRender');
            container.innerHTML = '';
            
            quizQuestions.forEach((q, idx) => {
                const div = document.createElement('div');
                div.className = 'question-card';
                let opts = '';
                q.options.forEach((opt, optIdx) => {
                    opts += `<label class="q-option"><input type="radio" name="game_q_${idx}" value="${optIdx}"> <span>${opt}</span></label>`;
                });
                div.innerHTML = `<div class="q-text">${idx+1}. ${q.q}</div><div class="q-options">${opts}</div>`;
                container.appendChild(div);
            });

            document.getElementById('gameIntro').classList.add('hidden');
            document.getElementById('gameQuestions').classList.remove('hidden');
            document.getElementById('gameResult').classList.add('hidden');
        }

        function submitGame() {
            let correctCount = 0;
            quizQuestions.forEach((q, idx) => {
                const selected = document.querySelector(`input[name="game_q_${idx}"]:checked`);
                if(selected && parseInt(selected.value) === q.ans) {
                    correctCount++;
                }
            });

            const score = correctCount * 10;
            
            const { studentId, className, quizNum } = window.currentGame;

            if(!appData.quizzes[className]) appData.quizzes[className] = {};
            if(!appData.quizzes[className][studentId]) appData.quizzes[className][studentId] = {};

            appData.quizzes[className][studentId][quizNum] = score;
            saveData();
            
            document.getElementById('finalScoreDisplay').innerText = score;
            document.getElementById('resultMessage').innerText = `Hebat ${window.currentGame.studentName}! Nilai ${score} telah disimpan otomatis ke Rekap Kuis ${quizNum}.`;

            document.getElementById('gameQuestions').classList.add('hidden');
            document.getElementById('gameResult').classList.remove('hidden');

            renderTableBody();
        }

        function resetGame() {
            document.getElementById('gameNameInput').value = '';
            document.getElementById('gameIntro').classList.remove('hidden');
            document.getElementById('gameQuestions').classList.add('hidden');
            document.getElementById('gameResult').classList.add('hidden');
        }

        // --- UI & TABLE LOGIC ---
        function toggleMusic() {
            const audio = document.getElementById("bgMusic");
            const btn = document.getElementById('btnMusic');
            const label = document.getElementById('musicLabel');
            
            // Fungsi ini dipindahkan ke toggleMusic() di atas untuk handle UI state
            // Panggil toggleMusic saja, jangan duplikasi logika
            // Karena user minta tombol musik tetap, mungkin tombolnya sendiri cukup
            // Tapi jika ingin tombol khusus 'Pause/Play', gunakan logika di atas.
            // Disini saya panggil fungsi standar:
            const savedMusicState = localStorage.getItem(MUSIC_KEY);
            if (savedMusicState === 'true') {
                isPlaying = true;
                updateMusicButtonUI(true);
                const audio = document.getElementById("bgMusic");
                audio.play().catch(e => console.log("Autoplay blocked:", e));
            } else {
                isPlaying = false;
                updateMusicButtonUI(false);
            }
        }

        function toggleLock() {
            isLocked = !isLocked;
            const btn = document.getElementById('btnLock');
            if(isLocked) {
                btn.classList.add('locked');
                btn.innerHTML = 'üîí <span>Buka</span>';
            } else {
                btn.classList.remove('locked');
                btn.innerHTML = 'üîì <span>Kunci</span>';
            }
            renderTableBody();
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        function addStudent() {
            const name = document.getElementById('inpName').value.trim();
            if(!name) return;
            const currentClass = classes[appData.currentClassIdx];
            const id = Date.now().toString(); 
            appData.students[currentClass].push({id, name});
            document.getElementById('inpName').value = '';
            saveData();
            renderTableBody();
            updateGameUI();
        }

        function handleEnter(e) { if(e.key === 'Enter') addStudent(); }

        function deleteStudent(id) {
            if(!confirm("Yakin hapus?")) return;
            const currentClass = classes[appData.currentClassIdx];
            appData.students[currentClass] = appData.students[currentClass].filter(s => s.id !== id);
            saveData();
            renderTableBody();
        }

        function renderTableHeader() {
            const thead = document.getElementById('tableHeader');
            constad.innerHTML = '';
            const mode = appData.viewMode;

            // Header Khusus dengan No, Nama, P1-P16 (SEMUA DIBUKA)
            if (mode === 'absen') {
                constad.innerHTML += `<th class="sticky-col">No</th>`;
                constad.innerHTML += `<th class="sticky-col-second">Nama Siswa</th>`;
                for(let i=1; i<=totalDays; i++) {
                    constad.innerHTML += `<th>P${i}</th>`;
                }
            } else if (mode === 'nilai') {
                constad.innerHTML += `<th class="sticky-col">No</th>`;
                constad.innerHTML += `<th class="sticky-col-second">Nama Siswa</th>`;
                for(let i=1; i<=totalDays; i++) {
                    constad.innerHTML += `<th>P${i}</th>`;
                }
            } else if (mode === 'quiz') {
                constad.innerHTML += `<th class="sticky-col">No</th>`;
                constad.innerHTML += `<th class="sticky-col-second">Nama Siswa</th>`;
                for(let i=1; i<=totalQuizzes; i++) {
                    constad.innerHTML += `<th>Kuis ${i}</th>`;
                }
                constad.innerHTML += `<th>Rata-rata</th>`;
            } else if (mode === 'recap_absen') {
                constad.innerHTML += `<th class="sticky-col">No</th>`;
                constad.innerHTML += `<th class="sticky-col-second">Nama Siswa</th>`;
                ['H', 'I', 'S', 'A'].forEach(s => {
                    constad.innerHTML += `<th>${s}</th>`;
                });
            } else if (mode === 'recap_nilai') {
                constad.innerHTML += `<th class="sticky-col">No</th>`;
                constad.innerHTML += `<th class="sticky-col-second">Nama Siswa</th>`;
                constad.innerHTML += `<th>Rata-rata</th>`;
            } else if (mode === 'hasil') {
                constad.innerHTML += `<th class="sticky-col">No</th>`;
                constad.innerHTML += `<th class="sticky-col-second">Nama Siswa</th>`;
                constad.innerHTML += `<th>Nilai Akhir</th>`;
            }
        }

        function renderTableBody() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            const currentClass = classes[appData.currentClassIdx];
            const students = appData.students[currentClass];
            const mode = appData.viewMode;
            const monthIdx = appData.currentMonthIdx;

            students.forEach((s, index) => {
                const tr = document.createElement('tr');
                
                // Kolom No
                let rowHtml = `<td class="sticky-col" style="left:0;">${index+1}</td>`;
                
                // Kolom Nama
                rowHtml += `<td class="sticky-col-second"><span>${s.name}</span><span class="btn-del" onclick="deleteStudent('${s.id}')">&times;</span></td>`;

                if (mode === 'absen') {
                    // MENGGANTI LOGIKA: SEMUA P1-P16 DIBUKA (TANPA PENGECEKAN)
                    for(let i=1; i<=totalDays; i++) {
                        const key = `${monthIdx}-${i}`;
                        const val = appData.attendance[currentClass][s.id]?.[key] || '';
                        
                        // Render selalu normal
                        rowHtml += `<td><div class="day-cell status-${val}" onclick="cycleStatus('${s.id}', '${key}')">${val}</div></td>`;
                    }
                } else if (mode === 'nilai') {
                    for(let i=1; i<=totalDays; i++) {
                        const key = `${monthIdx}-${i}`;
                        const val = appData.grades[currentClass][s.id]?.[key] || '';
                        // Nilai selalu bisa diisi
                        rowHtml += `<td><input type="number" class="grade-input" value="${val}" onchange="setGrade('${s.id}', '${key}', this.value)" ${isLocked?'disabled':''} min="0" max="100"></td>`;
                    }
                } else if (mode === 'quiz') {
                    let sumQuiz = 0; let countQuiz = 0;
                    for(let i=1; i<=totalQuizzes; i++) {
                        const qId = i.toString();
                        const val = appData.quizzes[currentClass][s.id]?.[qId] || '';
                        if(val !== '') { sumQuiz += parseInt(val); countQuiz++; }
                        rowHtml += `<td><input type="number" class="grade-input" style="color:var(--quiz-color);" value="${val}" onchange="setQuiz('${s.id}', '${qId}', this.value)" ${isLocked?'disabled':''} min="0" max="100"></td>`;
                    }
                    const avgQuiz = countQuiz > 0 ? Math.round(sumQuiz/countQuiz) : 0;
                    rowHtml += `<td class="quiz-avg">${avgQuiz}</td>`;
                } else if (mode === 'recap_absen') {
                    const counts = {H:0, I:0, S:0, A:0};
                    for(let i=1; i<=totalDays; i++) {
                        const key = `${monthIdx}-${i}`;
                        const val = appData.attendance[currentClass][s.id]?.[key] || '';
                        if(counts[val] !== undefined) counts[val]++;
                    }
                    rowHtml += `<td>${counts.H}</td><td>${counts.I}</td><td>${counts.S}</td><td>${counts.A}</td>`;
                } else if (mode === 'recap_nilai') {
                    let sum = 0, count = 0;
                    for(let i=1; i<=totalDays; i++) {
                        const key = `${monthIdx}-${i}`;
                        const val = appData.grades[currentClass][s.id]?.[key];
                        if(val && val !== '') { sum += parseInt(val); count++; }
                    }
                    const avg = count > 0 ? Math.round(sum/count) : 0;
                    rowHtml += `<td style="font-weight:bold; color:var(--secondary); font-size: 1.1rem;">${avg}</td>`;
                } else if (mode === 'hasil') {
                    let sum = 0, count = 0;
                    for(let i=1; i<=totalDays; i++) {
                        const key = `${monthIdx}-${i}`;
                        const val = appData.grades[currentClass][s.id]?.[key];
                        if(val && val !== '') { sum += parseInt(val); count++; }
                    }
                    const avgDaily = count > 0 ? Math.round(sum/count) : 100; 

                    let sumQuiz = 0, countQuiz = 0;
                    for(let i=1; i<=totalQuizzes; i++) {
                        const val = appData.quizzes[currentClass][s.id]?.[i.toString()];
                        if(val && val !== '') { sumQuiz += parseInt(val); countQuiz++; }
                    }
                    const avgQuiz = countQuiz > 0 ? Math.round(sumQuiz/countQuiz) : 0;

                    const baseScore = (avgDaily + avgQuiz) / 2;

                    const counts = {H:0, I:0, S:0, A:0};
                    for(let i=1; i<=totalDays; i++) {
                        const key = `${monthIdx}-${i}`;
                        const val = appData.attendance[currentClass][s.id]?.[key] || '';
                        if(counts[val] !== undefined) counts[val]++;
                    }

                    let finalScore = Math.round(baseScore) - (counts.A * PENALTI_ALPHA) - (counts.S * PENALTI_SAKIT) - (counts.I * PENALTI_IZIN);
                    if(finalScore < 0) finalScore = 0;

                    let badgeClass = 'score-med';
                    if(finalScore >= 85) badgeClass = 'score-high';
                    else if(finalScore < 75) badgeClass = 'score-low';

                    rowHtml += `<td><span class="score-badge ${badgeClass}">${finalScore}</span></td>`;
                }

                tr.innerHTML = rowHtml;
                tbody.appendChild(tr);
            });
        }

        // --- FUNGSI SIKLIK (MENGGANTI LOGIKA: SUDAH HAPUS GATEKEEPER) ---
        function cycleStatus(sid, key) {
            if(isLocked) return;
            
            const currentClass = classes[appData.currentClassIdx];
            
            if(!appData.attendance[currentClass]) appData.attendance[currentClass] = {};
            if(!appData.attendance[currentClass][sid]) appData.attendance[currentClass][sid] = {};

            const current = appData.attendance[currentClass][sid][key] || '';
            
            // Urutan: H, Ijin, Sakit, Alfa
            const statuses = ['', 'H', 'I', 'S', 'A']; 
            const idx = statuses.indexOf(current);
            const next = statuses[(idx + 1) % statuses.length];
            
            appData.attendance[currentClass][sid][key] = next;
            
            saveData();
            renderTableBody();
        }

        function setGrade(sid, key, val) {
            if(isLocked) return;
            const currentClass = classes[appData.currentClassIdx];
            if(!appData.grades[currentClass]) appData.grades[currentClass] = {};
            if(!appData.grades[currentClass][sid]) appData.grades[currentClass][sid] = {};
            appData.grades[currentClass][sid][key] = val;
            saveData();
        }

        function setQuiz(sid, key, val) {
            if(isLocked) return;
            const currentClass = classes[appData.currentClassIdx];
            if(!appData.quizzes[currentClass]) appData.quizzes[currentClass] = {};
            if(!appData.quizzes[currentClass][sid]) appData.quizzes[currentClass][sid] = {};
            appData.quizzes[currentClass][sid][key] = val;
            saveData();
        }

        function downloadCSV() {
            const currentClass = classes[appData.currentClassIdx];
            const students = appData.students[currentClass];
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "No,Nama Siswa," + Array.from({length: totalDays}, (_, i) => `P${i+1}`).join(",") + "\n";
            students.forEach((s, idx) => {
                let rowData = [idx+1, s.name];
                for(let i=1; i<=totalDays; i++) {
                    const key = `${appData.currentMonthIdx}-${i}`;
                    if(appData.viewMode === 'absen') {
                         rowData.push(appData.attendance[currentClass][s.id]?.[key] || '');
                    } else if (appData.viewMode === 'nilai') {
                         rowData.push(appData.grades[currentClass][s.id]?.[key] || '');
                    } else {
                         rowData.push('-');
                    }
                }
                csvContent += rowData.join(",") + "\n";
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `Data_${currentClass}_${months[appData.currentMonthIdx]}_${appData.currentYear}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>